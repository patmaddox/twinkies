#!/usr/bin/env ruby
require 'rubygems'
begin
  require 'twinkies'
rescue LoadError
  $:.unshift File.dirname(__FILE__) + '/../lib'
  require 'twinkies'
end
require 'sinatra'

include Twinkies

DataMapper.setup(:default, "sqlite3:///tmp/twinkies-test.db")

Thread.new do
  loop { puts "refreshing tweets..."; Item.refresh; sleep(60) }
end

get '/feed.xml' do
  builder do |xml|
    xml.instruct!
    xml.rss :version => '2.0' do
      xml.channel do
        xml.title "#{ENV['TWITTER_NICK']}'s twitter URL feed"
        xml.description "#{ENV['TWITTER_NICK']}'s twitter URL feed"
        xml.link "http://twitter.com/#{ENV['TWITTER_NICK']}"

        Item.latest.each do |tweet|
          xml.item do
            xml.title "#{tweet.user} - #{tweet.text}"
            xml.link tweet.link
            xml.pubDate tweet.created_at
            xml.guid tweet.id, :isPermaLink => false
          end
        end
      end
    end
  end
end
