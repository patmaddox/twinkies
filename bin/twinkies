#!/usr/bin/env ruby
require 'rubygems'
begin
  require 'twinkies'
rescue LoadError
  $:.unshift File.dirname(__FILE__) + '/../lib'
  require 'twinkies'
end
require 'sinatra'

include Twinkies

DataMapper.setup(:default, "sqlite3:///tmp/twinkies-test.db")

def refresh_tweets
  tweets = FriendSearcher.new(ENV['TWITTER_NICK'], ENV['TWITTER_PASS']).search('http')
  UrlList.new(tweets) {|t| t.text}.each do |item|
    Item.create :link => item[:url], :tweet => item[:item]
  end
end

def items
  Item.all(:order => [:twitter_id.desc])
end

get '/feed.xml' do
  refresh_tweets
  builder do |xml|
    xml.instruct!
    xml.rss :version => '2.0' do
      xml.channel do
        xml.title "#{ENV['TWITTER_NICK']}'s twitter URL feed"
        xml.description "#{ENV['TWITTER_NICK']}'s twitter URL feed"
        xml.link "http://twitter.com/#{ENV['TWITTER_NICK']}"

        items.each do |tweet|
          xml.item do
            xml.title "#{tweet.user} - #{tweet.text}"
            xml.link tweet.link
            xml.pubDate tweet.created_at
            xml.guid tweet.id, :isPermaLink => false
          end
        end
      end
    end
  end
end
